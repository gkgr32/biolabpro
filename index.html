import React, { useState, useEffect, useCallback, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, serverTimestamp, setDoc } from 'firebase/firestore';

// --- FIREBASE SETUP ---
// Global variables provided by the environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Context for Firebase and User Info
const FirebaseContext = createContext(null);

const FirebaseProvider = ({ children }) => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    useEffect(() => {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Application cannot proceed.");
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const firebaseAuth = getAuth(app);

            setDb(firestore);
            setAuth(firebaseAuth);

            // Authentication Listener
            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsAuthReady(true);
                } else {
                    // Sign in using custom token or anonymously if token is unavailable
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        } else {
                            await signInAnonymously(firebaseAuth);
                        }
                    } catch (error) {
                        console.error("Firebase Authentication Error:", error);
                        setIsAuthReady(true); // Allow UI to render even if sign-in failed
                    }
                }
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setIsAuthReady(true);
        }
    }, []);

    return (
        <FirebaseContext.Provider value={{ db, auth, userId, isAuthReady, appId }}>
            {children}
        </FirebaseContext.Provider>
    );
};

const useFirebase = () => useContext(FirebaseContext);

// --- HELPER COMPONENTS ---

const CustomButton = ({ children, onClick, className = '' }) => (
    <button
        onClick={onClick}
        className={`px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-blue-300 ${className}`}
    >
        {children}
    </button>
);

const SectionTitle = ({ children }) => (
    <h2 className="text-3xl font-extrabold text-gray-800 mb-6 border-b-2 border-blue-200 pb-2">
        {children}
    </h2>
);

const SectionContainer = ({ children }) => (
    <div className="bg-white p-8 rounded-xl shadow-2xl transition duration-500 ease-in-out hover:shadow-3xl">
        {children}
    </div>
);

const Loader = () => (
    <div className="flex items-center justify-center space-x-2 p-8">
        <div className="w-4 h-4 bg-blue-600 rounded-full animate-bounce delay-100"></div>
        <div className="w-4 h-4 bg-blue-600 rounded-full animate-bounce delay-200"></div>
        <div className="w-4 h-4 bg-blue-600 rounded-full animate-bounce delay-300"></div>
        <p className="text-gray-600 ml-4">Φόρτωση δεδομένων...</p>
    </div>
);

// --- PAGES ---

const HomePage = () => (
    <SectionContainer>
        <SectionTitle>Καλώς ήρθατε στην Έρευνα Καινοτομίας</SectionTitle>
        <p className="text-lg text-gray-700 mb-6 leading-relaxed">
            Το πρόγραμμα PETIE στοχεύει στην καταγραφή και ανάλυση των καινοτόμων πρακτικών
            που εφαρμόζονται στις επιχειρήσεις. Η συμβολή σας είναι καθοριστική για την
            κατανόηση των σύγχρονων τάσεων και τη διαμόρφωση του μέλλοντος της καινοτομίας.
        </p>
        <div className="grid md:grid-cols-3 gap-6 text-center">
            <div className="p-4 bg-blue-50 rounded-lg shadow-inner">
                <h3 className="text-xl font-bold text-blue-700 mb-2">Εύκολη Συμμετοχή</h3>
                <p className="text-gray-600">Συμπληρώστε τη φόρμα σε λίγα λεπτά.</p>
            </div>
            <div className="p-4 bg-blue-50 rounded-lg shadow-inner">
                <h3 className="text-xl font-bold text-blue-700 mb-2">Ανώνυμα Δεδομένα</h3>
                <p className="text-gray-600">Τα δεδομένα σας παραμένουν εμπιστευτικά.</p>
            </div>
            <div className="p-4 bg-blue-50 rounded-lg shadow-inner">
                <h3 className="text-xl font-bold text-blue-700 mb-2">Σημαντική Συμβολή</h3>
                <p className="text-gray-600">Βοηθήστε στη διαμόρφωση της εθνικής στρατηγικής.</p>
            </div>
        </div>
        <div className="mt-8 pt-6 border-t border-gray-100">
             <CustomButton onClick={() => document.querySelector('.main-app-container').scrollIntoView({ behavior: 'smooth' })}>
                Μάθετε Περισσότερα
             </CustomButton>
        </div>
    </SectionContainer>
);

const AboutPage = () => (
    <SectionContainer>
        <SectionTitle>Σχετικά με το Πρόγραμμα PETIE</SectionTitle>
        <div className="space-y-6 text-gray-700">
            <p className="leading-relaxed">
                Το PETIE (Παρατηρητήριο Επιχειρηματικής Καινοτομίας και Τεχνολογικής Εξέλιξης) είναι μια πρωτοβουλία
                που προέκυψε από τη συνεργασία του Πανεπιστημίου Δυτικής Αττικής (ΠΑΔΑ) και του Κέντρου
                Καινοτομίας UNOVATE. Στόχος μας είναι η συστηματική παρακολούθηση και ανάλυση των τάσεων
                στην καινοτομία των ελληνικών επιχειρήσεων.
            </p>
            <h3 className="text-2xl font-semibold text-gray-800 border-l-4 border-blue-500 pl-3">Οι Στόχοι μας</h3>
            <ul className="list-disc list-inside space-y-2 ml-4">
                <li>Καταγραφή των επιπέδων ψηφιακού μετασχηματισμού.</li>
                <li>Ανάλυση των επενδύσεων σε Έρευνα & Ανάπτυξη (R&D).</li>
                <li>Προσδιορισμός των εμποδίων στην υιοθέτηση καινοτόμων πρακτικών.</li>
                <li>Διαμόρφωση προτάσεων πολιτικής για την ενίσχυση της ανταγωνιστικότητας.</li>
            </ul>
        </div>
    </SectionContainer>
);

const FormPage = ({ setPage }) => {
    const { db, userId, appId, isAuthReady } = useFirebase();
    const [formData, setFormData] = useState({
        companyName: '',
        industry: '',
        employeeCount: '',
        innovationType: '',
        contactEmail: ''
    });
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [message, setMessage] = useState('');

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setMessage('');

        if (!isAuthReady || !userId || !db) {
            setMessage('Αναμονή για σύνδεση με τη βάση δεδομένων. Δοκιμάστε ξανά σε λίγο.');
            return;
        }

        // Simple validation
        if (!formData.companyName || !formData.contactEmail || !formData.innovationType) {
            setMessage('Παρακαλώ συμπληρώστε όλα τα απαιτούμενα πεδία.');
            return;
        }

        setIsSubmitting(true);
        try {
            // Firestore path: /artifacts/{appId}/public/data/expressions_of_interest/{docId}
            const collectionPath = `artifacts/${appId}/public/data/expressions_of_interest`;
            const docRef = collection(db, collectionPath);

            await addDoc(docRef, {
                ...formData,
                userId: userId,
                timestamp: serverTimestamp(),
            });

            setMessage('✅ Η δήλωση ενδιαφέροντος υποβλήθηκε επιτυχώς! Ευχαριστούμε για τη συμμετοχή σας.');
            setFormData({
                companyName: '',
                industry: '',
                employeeCount: '',
                innovationType: '',
                contactEmail: ''
            });

        } catch (error) {
            console.error("Error submitting form:", error);
            setMessage('❌ Αποτυχία υποβολής. Παρακαλώ ελέγξτε τη σύνδεσή σας ή δοκιμάστε αργότερα.');
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <SectionContainer>
            <SectionTitle>Φόρμα Εκδήλωσης Ενδιαφέροντος</SectionTitle>
            <p className="text-gray-600 mb-8">
                Εκδηλώστε το ενδιαφέρον σας για συμμετοχή στην επόμενη φάση της έρευνας.
            </p>

            <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                    <label htmlFor="companyName" className="block text-sm font-medium text-gray-700 mb-1">
                        Επωνυμία Επιχείρησης *
                    </label>
                    <input
                        type="text"
                        name="companyName"
                        id="companyName"
                        value={formData.companyName}
                        onChange={handleChange}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Όνομα Εταιρείας"
                        required
                    />
                </div>

                <div>
                    <label htmlFor="contactEmail" className="block text-sm font-medium text-gray-700 mb-1">
                        Email Επικοινωνίας *
                    </label>
                    <input
                        type="email"
                        name="contactEmail"
                        id="contactEmail"
                        value={formData.contactEmail}
                        onChange={handleChange}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        placeholder="email@example.com"
                        required
                    />
                </div>

                <div>
                    <label htmlFor="industry" className="block text-sm font-medium text-gray-700 mb-1">
                        Κλάδος Δραστηριότητας
                    </label>
                    <select
                        name="industry"
                        id="industry"
                        value={formData.industry}
                        onChange={handleChange}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">Επιλέξτε Κλάδο</option>
                        <option value="IT">Πληροφορική / Τεχνολογία</option>
                        <option value="Manufacturing">Βιομηχανία / Παραγωγή</option>
                        <option value="Services">Υπηρεσίες</option>
                        <option value="Trade">Εμπόριο</option>
                        <option value="Other">Άλλο</option>
                    </select>
                </div>

                <div>
                    <label htmlFor="innovationType" className="block text-sm font-medium text-gray-700 mb-1">
                        Ποιος τύπος καινοτομίας σας ενδιαφέρει; *
                    </label>
                    <textarea
                        name="innovationType"
                        id="innovationType"
                        value={formData.innovationType}
                        onChange={handleChange}
                        rows="3"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Π.χ. Καινοτομία προϊόντος, διαδικασίας, μάρκετινγκ ή οργανωτική."
                        required
                    ></textarea>
                </div>

                {message && (
                    <div className={`p-4 rounded-lg text-sm ${message.startsWith('✅') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                        {message}
                    </div>
                )}

                <CustomButton type="submit" className="w-full" disabled={isSubmitting || !isAuthReady}>
                    {isSubmitting ? 'Υποβολή...' : 'Υποβολή Δήλωσης'}
                </CustomButton>
            </form>
        </SectionContainer>
    );
};

// --- MAIN APP COMPONENT ---

const unovateLogo = "https://placehold.co/120x56/0C4A6E/FFFFFF?text=UNOVATE";
const padaLogo = "https://placehold.co/120x56/4A67A5/FFFFFF?text=ΠΑΔΑ";
const petieLogo = "https://placehold.co/120x56/C42026/FFFFFF?text=PETIE";

export default function App() {
    return (
        <FirebaseProvider>
            <AppContent />
        </FirebaseProvider>
    );
}

const AppContent = () => {
    const [page, setPage] = useState('home');
    const { isAuthReady, userId } = useFirebase();

    if (!isAuthReady) {
        return <Loader />;
    }

    const renderPage = () => {
        switch (page) {
            case 'home':
                return <HomePage />;
            case 'about':
                return <AboutPage />;
            case 'form':
                return <FormPage setPage={setPage} />;
            default:
                return <HomePage />;
        }
    };

    return (
        <div className="min-h-screen bg-gray-50 font-sans main-app-container">
            {/* Header / Navigation Bar */}
            <header className="flex flex-col md:flex-row items-center justify-between p-6 bg-white shadow-md">
                
                {/* Container Λογότυπων (Αριστερά, Κέντρο, Δεξιά) */}
                {/* UPDATED: justify-center, gap-12, and increased size to h-14 */}
                <div className="flex items-center w-full md:w-2/3 justify-center gap-12">
                    
                    {/* Logo 1: UNOVATE (Αριστερά) */}
                    <img src={unovateLogo} alt="UNOVATE" className="h-14" />
                    
                    {/* Logo 2: ΠΑΔΑ (Κέντρο) */}
                    <img src={padaLogo} alt="ΠΑΔΑ" className="h-14" />

                    {/* Logo 3: PETIE (Δεξιά) */}
                    <img src={petieLogo} alt="PETIE" className="h-14" />
                </div>

                {/* Γραμμή Πλοήγησης (Παραμένει στα δεξιά του header) */}
                <nav className="mt-4 md:mt-0 space-x-4 text-sm font-medium">
                    <CustomButton onClick={() => setPage('home')} className="!bg-transparent text-gray-800 hover:text-blue-600 shadow-none p-0">Αρχική</CustomButton>
                    <CustomButton onClick={() => setPage('about')} className="!bg-transparent text-gray-800 hover:text-blue-600 shadow-none p-0">Σχετικά</CustomButton>
                    <CustomButton onClick={() => setPage('form')} className="!bg-transparent text-gray-800 hover:text-blue-600 shadow-none p-0">Εκδήλωση Ενδιαφέροντος</CustomButton>
                </nav>
            </header>

            {/* Main Content */}
            <main className="container mx-auto p-6 md:p-10">
                <div className="max-w-4xl mx-auto">
                    {renderPage()}
                </div>
            </main>

            {/* Footer */}
            <footer className="w-full bg-gray-800 text-white p-6 mt-10">
                <div className="container mx-auto text-center text-sm">
                    <p>
                        Έρευνα PETIE - Πανεπιστήμιο Δυτικής Αττικής & UNOVATE |
                        <span className="ml-2 text-xs text-gray-400">User ID: {userId || 'N/A'}</span>
                    </p>
                </div>
            </footer>
        </div>
    );
};
